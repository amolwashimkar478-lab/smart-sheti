<!DOCTYPE html>
<html lang="mr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ЁЯМ┐ рд╕реНрдорд╛рд░реНрдЯ рд╢реЗрддреА - рд░реЛрдЧ рдУрд│рдЦ</title>
<style>
  body { font-family: Arial; background:#e8f5e9; padding:20px; text-align:center; }
  .container { max-width:420px; margin:auto; }
  .card { background:#fff; padding:20px; border-radius:18px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
  h2 { color:#2e7d32; }
  .btn-row { display:flex; gap:10px; margin:15px 0; }
  button { flex:1; padding:14px; border:none; border-radius:14px; font-size:16px; color:white; cursor:pointer; }
  .camera { background:#2e7d32; }
  .gallery { background:#1565c0; }
  .detect { background:#388e3c; width:100%; margin-top:10px; font-weight:bold; }
  .back { background:#1976d2; width:100%; margin-top:15px; }
  .result { margin-top:12px; background:#f1f8e9; padding:15px; border-radius:10px; text-align:left; line-height:1.5; min-height:50px; }
  input[type=file] { display:none; }
</style>
</head>
<body>

<div class="container">
  <h2>ЁЯУ╕ рдкрд┐рдХрд╛рдЪрд╛ рдлреЛрдЯреЛ рдЯрд╛рдХрд╛</h2>
  <div class="card">
    <input type="file" id="cameraInput" accept="image/*" capture="environment">
    <input type="file" id="galleryInput" accept="image/*">
    <div class="btn-row">
      <button class="camera" onclick="document.getElementById('cameraInput').click()">ЁЯУ╖ рдХреЕрдореЗрд░рд╛</button>
      <button class="gallery" onclick="document.getElementById('galleryInput').click()">ЁЯЦ╝я╕П рдЧреЕрд▓рд░реА</button>
    </div>
    <button class="detect" id="btnDetect" onclick="analyze()">ЁЯФН рд░реЛрдЧ рдУрд│рдЦрд╛</button>
    <div class="result" id="result">рдпреЗрдереЗ рдорд╛рд╣рд┐рддреА рджрд┐рд╕реЗрд▓...</div>
  </div>
  <button class="back" onclick="location.href='home.html'">тмЕ рдореБрдЦреНрдп рдкреЗрдЬ</button>
</div>

<script>
let selectedFileBase64 = null;

function handleFile(e) {
  const file = e.target.files[0];
  if (file) {
    // рдлреЛрдЯреЛрдЪреА рд╕рд╛рдИрдЬ рдЪреЗрдХ рдХрд░рдгреЗ (4MB рдкреЗрдХреНрд╖рд╛ рдХрдореА рдЕрд╕рд╛рд╡реА)
    if (file.size > 4 * 1024 * 1024) {
      alert("рдлреЛрдЯреЛ рдЦреВрдк рдореЛрдард╛ рдЖрд╣реЗ, рдХреГрдкрдпрд╛ рд▓рд╣рд╛рди рдлреЛрдЯреЛ рдирд┐рд╡рдбрд╛.");
      return;
    }
    const reader = new FileReader();
    reader.onload = (event) => {
      selectedFileBase64 = event.target.result.split(",")[1];
      document.getElementById("result").innerText = "тЬЕ рдлреЛрдЯреЛ рддрдпрд╛рд░ рдЖрд╣реЗ. рдЖрддрд╛ 'рд░реЛрдЧ рдУрд│рдЦрд╛' рджрд╛рдмрд╛.";
    };
    reader.readAsDataURL(file);
  }
}

document.getElementById("cameraInput").onchange = handleFile;
document.getElementById("galleryInput").onchange = handleFile;

async function analyze(){
  if(!selectedFileBase64){
    alert("рдЖрдзреА рдлреЛрдЯреЛ рдирд┐рд╡рдбрд╛");
    return;
  }

  const resultDiv = document.getElementById("result");
  const btn = document.getElementById("btnDetect");
  
  resultDiv.innerText = "тП│ рддрдкрд╛рд╕рдгреА рд╕реБрд░реВ рдЖрд╣реЗ, рдХреГрдкрдпрд╛ рд╡рд╛рдЯ рдкрд╣рд╛...";
  btn.disabled = true;

  try {
    const res = await fetch("/api/chat", {
      method:"POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ image: selectedFileBase64, city: "Pune" })
    });

    const data = await res.json();
    resultDiv.innerText = data.reply;

    // рдЖрд╡рд╛рдЬ рд╕реБрд░реВ рдХрд░рдгреЗ
    const msg = new SpeechSynthesisUtterance(data.reply);
    msg.lang = "mr-IN";
    speechSynthesis.speak(msg);

  } catch(e) {
    resultDiv.innerText = "рд╕рд░реНрд╡реНрд╣рд░рд╢реА рд╕рдВрдкрд░реНрдХ рдЭрд╛рд▓рд╛ рдирд╛рд╣реА: " + e.message;
  } finally {
    btn.disabled = false;
  }
}
</script>
</body>
</html>
