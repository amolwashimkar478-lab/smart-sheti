<!DOCTYPE html>
<html lang="mr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ЁЯМ┐ рд╕реНрдорд╛рд░реНрдЯ рд╢реЗрддреА - рд░реЛрдЧ рдУрд│рдЦ</title>
<style>
  body { font-family: Arial, sans-serif; background:#e8f5e9; padding:20px; text-align:center; }
  .container { max-width:420px; margin:auto; }
  .card { background:#fff; padding:20px; border-radius:18px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
  h2 { color:#2e7d32; }
  .btn-row { display:flex; gap:10px; margin:15px 0; }
  button { flex:1; padding:14px; border:none; border-radius:14px; font-size:16px; color:white; cursor:pointer; font-weight:bold; }
  .camera { background:#2e7d32; }
  .gallery { background:#1565c0; }
  .detect { background:#388e3c; width:100%; margin-top:10px; }
  .back { background:#1976d2; width:100%; margin-top:15px; }
  .result { margin-top:12px; background:#f1f8e9; padding:15px; border-radius:10px; text-align:left; line-height:1.6; min-height:60px; font-size:15px; border: 1px solid #c8e6c9; }
  input[type=file] { display:none; }
  button:disabled { background: #ccc; cursor: not-allowed; }
</style>
</head>
<body>

<div class="container">
  <h2>ЁЯУ╕ рдкрд┐рдХрд╛рдЪрд╛ рдлреЛрдЯреЛ рдЯрд╛рдХрд╛</h2>
  <div class="card">
    <input type="file" id="cameraInput" accept="image/*" capture="environment">
    <input type="file" id="galleryInput" accept="image/*">

    <div class="btn-row">
      <button class="camera" onclick="document.getElementById('cameraInput').click()">ЁЯУ╖ рдХреЕрдореЗрд░рд╛</button>
      <button class="gallery" onclick="document.getElementById('galleryInput').click()">ЁЯЦ╝я╕П рдЧреЕрд▓рд░реА</button>
    </div>

    <button class="detect" id="btnDetect" onclick="analyze()">ЁЯФН рд░реЛрдЧ рдУрд│рдЦрд╛</button>
    <div class="result" id="result">рдкрд┐рдХрд╛рдЪрд╛ рдлреЛрдЯреЛ рдирд┐рд╡рдбрд╛ рдЖрдгрд┐ 'рд░реЛрдЧ рдУрд│рдЦрд╛' рдмрдЯрдг рджрд╛рдмрд╛.</div>
  </div>
  <button class="back" onclick="location.href='home.html'">тмЕ рдореБрдЦреНрдп рдкреЗрдЬ</button>
</div>

<script>
let selectedFileBase64 = null;

// рдлреЛрдЯреЛ рдХреЙрдореНрдкреНрд░реЗрд╕ рдЖрдгрд┐ рд░рд┐рд╕рд╛рдИрдЬ рдХрд░рдгреНрдпрд╛рдЪреЗ рд▓реЙрдЬрд┐рдХ
function handleFile(e) {
  const file = e.target.files[0];
  if (!file) return;

  document.getElementById("result").innerText = "тП│ рдлреЛрдЯреЛ рдкреНрд░реЛрд╕реЗрд╕ рд╣реЛрдд рдЖрд╣реЗ...";
  
  const reader = new FileReader();
  reader.onload = function(event) {
    const img = new Image();
    img.src = event.target.result;
    
    img.onload = function() {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      
      // рдлреЛрдЯреЛрдЪреА рд░реБрдВрджреА рдЬрд╛рд╕реНрддреАрдд рдЬрд╛рд╕реНрдд 800px рдареЗрд╡реВрдпрд╛ (рд╕рд╛рдИрдЬ рдХрдореА рдХрд░рдгреНрдпрд╛рд╕рд╛рдареА)
      const maxWidth = 800;
      const scale = maxWidth / img.width;
      canvas.width = maxWidth;
      canvas.height = img.height * scale;
      
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      
      // ренреж% рдХреНрд╡рд╛рд▓рд┐рдЯреАрдордзреНрдпреЗ JPEG рдлреЙрд░рдореЕрдЯрдордзреНрдпреЗ рд░реВрдкрд╛рдВрддрд░
      selectedFileBase64 = canvas.toDataURL('image/jpeg', 0.7).split(",")[1];
      document.getElementById("result").innerText = "тЬЕ рдлреЛрдЯреЛ рддрдпрд╛рд░ рдЖрд╣реЗ. рдЖрддрд╛ рддрдкрд╛рд╕рдгреА рдХрд░рд╛.";
    };
  };
  reader.readAsDataURL(file);
}

document.getElementById("cameraInput").onchange = handleFile;
document.getElementById("galleryInput").onchange = handleFile;

async function analyze() {
  if(!selectedFileBase64) {
    alert("рдХреГрдкрдпрд╛ рдЖрдзреА рдлреЛрдЯреЛ рдирд┐рд╡рдбрд╛ рдХрд┐рдВрд╡рд╛ рдХрд╛рдврд╛.");
    return;
  }

  const resultDiv = document.getElementById("result");
  const btn = document.getElementById("btnDetect");
  
  resultDiv.innerText = "тП│ рдПрдЖрдп рддрдкрд╛рд╕рдгреА рдХрд░рдд рдЖрд╣реЗ, рдХреГрдкрдпрд╛ рдереЛрдбрд╛ рд╡реЗрд│ рдерд╛рдВрдмрд╛...";
  btn.disabled = true;

  try {
    const res = await fetch("/api/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ 
        image: selectedFileBase64, 
        city: "Maharashtra", // рддреБрдореНрд╣реА рдпреБрдЬрд░рдЪреЗ рд▓реЛрдХреЗрд╢рди рдШреЗрдК рд╢рдХрддрд╛
        prompt: "рдпрд╛ рдкрд┐рдХрд╛рдЪреНрдпрд╛ рдлреЛрдЯреЛрдордзреАрд▓ рд░реЛрдЧ рдУрд│рдЦрд╛ рдЖрдгрд┐ рддреНрдпрд╛рд╡рд░ рдкреНрд░рддрд┐рдмрдВрдзрд╛рддреНрдордХ рдЙрдкрд╛рдп рдорд░рд╛рдареАрдд рд╕рд╛рдВрдЧрд╛."
      })
    });

    const data = await res.json();
    
    if(data.reply) {
      resultDiv.innerText = data.reply;
      
      // рдСрдбрд┐рдУ рд░рд┐рд╕реНрдкреЙрдиреНрд╕
      const msg = new SpeechSynthesisUtterance(data.reply);
      msg.lang = "mr-IN";
      window.speechSynthesis.speak(msg);
    } else {
      resultDiv.innerText = "рдХреНрд╖рдорд╕реНрд╡, рдорд╛рд╣рд┐рддреА рдорд┐рд│реВ рд╢рдХрд▓реА рдирд╛рд╣реА. рдХреГрдкрдпрд╛ рдкреБрдиреНрд╣рд╛ рдкреНрд░рдпрддреНрди рдХрд░рд╛.";
    }

  } catch (e) {
    resultDiv.innerText = "рдПрд░рд░: " + e.message;
    console.error(e);
  } finally {
    btn.disabled = false;
  }
}
</script>

</body>
</html>
