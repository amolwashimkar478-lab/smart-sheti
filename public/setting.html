<!DOCTYPE html>
<html lang="mr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile Settings - Smart Sheti</title>
    <style>
        :root {
            --primary: #2e7d32;
            --bg: #f8f9fa;
            --card: #ffffff;
            --text-main: #1a1a1a;
            --text-sub: #757575;
            --border: #eceff1;
        }

        body.dark-mode {
            --bg: #121212;
            --card: #1e1e1e;
            --text-main: #ffffff;
            --text-sub: #aaaaaa;
            --border: #333333;
        }

        body {
            font-family: 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0; padding: 0;
            transition: 0.3s;
        }

        .top-bar {
            background: var(--card);
            padding: 15px 20px;
            display: flex; align-items: center; justify-content: space-between;
            border-bottom: 1px solid var(--border);
            position: sticky; top: 0; z-index: 100;
        }

        .back-link { text-decoration: none; color: var(--text-main); font-size: 24px; }

        .profile-header {
            background: var(--card);
            padding: 30px 20px;
            text-align: center; margin-bottom: 10px;
        }

        .avatar-wrapper {
            position: relative; width: 110px; height: 110px;
            margin: 0 auto 15px; cursor: pointer;
        }

        .avatar {
            width: 100%; height: 100%; border-radius: 50%;
            object-fit: cover; border: 3px solid var(--primary); padding: 2px;
        }

        .edit-badge {
            position: absolute; bottom: 5px; right: 5px;
            background: var(--primary); color: white;
            width: 30px; height: 30px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            border: 2px solid var(--card); font-size: 14px;
        }

        .settings-group {
            background: var(--card); margin-bottom: 15px;
            border-top: 1px solid var(--border); border-bottom: 1px solid var(--border);
        }

        .setting-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px 20px; border-bottom: 1px solid var(--border);
        }

        .item-info label { display: block; font-size: 12px; color: var(--text-sub); margin-bottom: 4px; }
        .item-info input {
            border: none; outline: none; font-size: 16px;
            color: var(--text-main); background: transparent; width: 100%;
        }

        .switch { position: relative; display: inline-block; width: 45px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc; transition: .4s; border-radius: 24px;
        }
        .slider:before {
            position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px;
            background-color: white; transition: .4s; border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(21px); }

        .btn-container { padding: 15px 20px; }
        .btn {
            width: 100%; padding: 14px; border-radius: 12px;
            font-size: 16px; font-weight: 600; border: none;
            cursor: pointer; margin-bottom: 12px; transition: 0.2s;
        }

        .btn-edit { background: #e8f5e9; color: var(--primary); }
        .btn-save { background: var(--primary); color: white; display: none; }
        .btn-logout { background: #fff3e0; color: #e65100; border: 1px solid #ffe0b2; }
        .btn-delete { background: transparent; color: #d32f2f; font-size: 14px; }

        #toast {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: #333; color: white; padding: 12px 25px; border-radius: 50px;
            font-size: 14px; display: none; z-index: 1000;
        }
    </style>
</head>
<body>

<div class="top-bar">
    <a href="home.html" class="back-link">‚Üê</a>
    <h2 style="margin:0; font-size: 18px;">‡§™‡•ç‡§∞‡•ã‡§´‡§æ‡§á‡§≤</h2>
    <div style="font-size: 14px; color: var(--primary); font-weight:bold;">Smart Sheti</div>
</div>

<div class="profile-header">
    <div class="avatar-wrapper" id="profileTrigger">
        <img id="profilePic" src="https://via.placeholder.com/150" class="avatar">
        <div class="edit-badge">üì∑</div>
    </div>
    <input type="file" id="fileInput" hidden accept="image/*">
    <h3 id="displayUserName" style="margin:10px 0 5px;">‡§∂‡•á‡§§‡§ï‡§∞‡•Ä ‡§®‡§æ‡§µ</h3>
</div>

<div class="settings-group">
    <div class="setting-item">
        <div class="item-info" style="flex:1;">
            <label>‡§®‡§æ‡§µ</label>
            <input type="text" id="userName" placeholder="‡§§‡•Å‡§Æ‡§ö‡•á ‡§®‡§æ‡§µ" readonly>
        </div>
    </div>
    <div class="setting-item">
        <div class="item-info" style="flex:1;">
            <label>‡§ó‡§æ‡§µ</label>
            <input type="text" id="userVillage" placeholder="‡§ó‡§æ‡§µ‡§æ‡§ö‡•á ‡§®‡§æ‡§µ" readonly>
        </div>
    </div>
    <div class="setting-item">
        <div class="item-info" style="flex:1;">
            <label>‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§™‡•Ä‡§ï</label>
            <input type="text" id="userCrop" placeholder="‡§â‡§¶‡§æ. ‡§ï‡§æ‡§™‡•Ç‡§∏" readonly>
        </div>
    </div>
</div>

<div class="settings-group" id="themeGroup">
    <div class="setting-item">
        <div style="font-size:16px;">‡§°‡§æ‡§∞‡•ç‡§ï ‡§Æ‡•ã‡§° (Dark Mode)</div>
        <label class="switch">
            <input type="checkbox" id="themeToggle">
            <span class="slider"></span>
        </label>
    </div>
</div>

<div class="btn-container">
    <button class="btn btn-edit" id="editBtn">‡§™‡•ç‡§∞‡•ã‡§´‡§æ‡§á‡§≤ ‡§è‡§°‡§ø‡§ü ‡§ï‡§∞‡§æ</button>
    <button class="btn btn-save" id="saveBtn">‡§Æ‡§æ‡§π‡§ø‡§§‡•Ä ‡§∏‡•á‡§µ‡•ç‡§π ‡§ï‡§∞‡§æ</button>
    
    <div id="dangerZone">
        <button class="btn btn-logout" id="logoutBtn">‡§≤‡•â‡§ó‡§Ü‡§â‡§ü (Logout)</button>
        <button class="btn btn-delete" id="deleteBtn">‡§ñ‡§æ‡§§‡•á ‡§ï‡§æ‡§Ø‡§Æ‡§ö‡•á ‡§π‡§ü‡§µ‡§æ (Delete Account)</button>
    </div>
</div>

<div id="toast"></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signOut, deleteUser, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyA1M7dJ9KFVe1GAGWPPqLuAT7BEuIKsZkM",
        authDomain: "smart-sheti-6512e.firebaseapp.com",
        projectId: "smart-sheti-6512e",
        storageBucket: "smart-sheti-6512e.firebasestorage.app",
        messagingSenderId: "1086459599128",
        appId: "1:1086459599128:web:03a34ed9ea2b95b1ebe66d"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const userName = document.getElementById('userName');
    const userVillage = document.getElementById('userVillage');
    const userCrop = document.getElementById('userCrop');
    const displayUserName = document.getElementById('displayUserName');
    const profilePic = document.getElementById('profilePic');
    const editBtn = document.getElementById('editBtn');
    const saveBtn = document.getElementById('saveBtn');
    const dangerZone = document.getElementById('dangerZone');
    const themeGroup = document.getElementById('themeGroup');
    const themeToggle = document.getElementById('themeToggle');
    const toast = document.getElementById('toast');

    // ‡§•‡•Ä‡§Æ ‡§Æ‡•Ö‡§®‡•á‡§ú‡§Æ‡•á‡§Ç‡§ü
    if (localStorage.getItem('appTheme') === 'dark') {
        document.body.classList.add('dark-mode');
        themeToggle.checked = true;
    }
    themeToggle.onchange = () => {
        const theme = themeToggle.checked ? 'dark' : 'light';
        document.body.classList.toggle('dark-mode', themeToggle.checked);
        localStorage.setItem('appTheme', theme);
    };

    // ‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§ï‡§∞‡§£‡•á
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            loadFromLocal();
            try {
                const docSnap = await getDoc(doc(db, "users", user.uid));
                if (docSnap.exists()) {
                    const d = docSnap.data();
                    userName.value = d.name || "";
                    userVillage.value = d.village || "";
                    userCrop.value = d.crop || "";
                    if(d.photo) profilePic.src = d.photo;
                    displayUserName.innerText = d.name || "‡§∂‡•á‡§§‡§ï‡§∞‡•Ä ‡§®‡§æ‡§µ";
                    saveToLocal(d.name, d.village, d.crop, d.photo);
                }
            } catch(e) { console.log("Firestore load error"); }
        } else {
            window.location.replace("index.html");
        }
    });

    function loadFromLocal() {
        userName.value = localStorage.getItem("prof_name") || "";
        userVillage.value = localStorage.getItem("prof_village") || "";
        userCrop.value = localStorage.getItem("prof_crop") || "";
        if(localStorage.getItem("prof_photo")) profilePic.src = localStorage.getItem("prof_photo");
        displayUserName.innerText = userName.value || "‡§∂‡•á‡§§‡§ï‡§∞‡•Ä ‡§®‡§æ‡§µ";
    }

    function saveToLocal(n, v, c, p) {
        localStorage.setItem("prof_name", n);
        localStorage.setItem("prof_village", v);
        localStorage.setItem("prof_crop", c);
        if(p) localStorage.setItem("prof_photo", p);
    }

    // ‚úÖ ‡§è‡§°‡§ø‡§ü ‡§Æ‡•ã‡§° (‡§¨‡§ü‡§£‡•á ‡§ó‡§æ‡§Ø‡§¨ ‡§ï‡§∞‡§£‡•á)
    editBtn.onclick = () => {
        [userName, userVillage, userCrop].forEach(i => i.readOnly = false);
        userName.focus();
        editBtn.style.display = "none";
        saveBtn.style.display = "block";
        
        // ‡§≤‡•â‡§ó‡§Ü‡§â‡§ü, ‡§°‡§ø‡§≤‡•Ä‡§ü ‡§Ü‡§£‡§ø ‡§•‡•Ä‡§Æ ‡§ë‡§™‡•ç‡§∂‡§® ‡§ó‡§æ‡§Ø‡§¨ ‡§ï‡§∞‡§æ
        dangerZone.style.display = "none";
        themeGroup.style.display = "none";
    };

    // ‚úÖ ‡§Æ‡§æ‡§π‡§ø‡§§‡•Ä ‡§∏‡•á‡§µ‡•ç‡§π ‡§ï‡§∞‡§£‡•á (‡§¨‡§ü‡§£‡•á ‡§™‡§∞‡§§ ‡§Ü‡§£‡§£‡•á)
    saveBtn.onclick = async () => {
        const u = auth.currentUser;
        if(!u) return;

        const data = {
            name: userName.value,
            village: userVillage.value,
            crop: userCrop.value,
            photo: profilePic.src,
            uid: u.uid
        };

        try {
            await setDoc(doc(db, "users", u.uid), data);
            saveToLocal(data.name, data.village, data.crop, data.photo);
            displayUserName.innerText = data.name;
            
            [userName, userVillage, userCrop].forEach(i => i.readOnly = true);
            saveBtn.style.display = "none";
            editBtn.style.display = "block";
            
            // ‡§¨‡§ü‡§£‡•á ‡§™‡•Å‡§®‡•ç‡§π‡§æ ‡§¶‡§æ‡§ñ‡§µ‡§æ
            dangerZone.style.display = "block";
            themeGroup.style.display = "block";
            
            showToast("‡§Æ‡§æ‡§π‡§ø‡§§‡•Ä ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§ø‡§§ ‡§∏‡§æ‡§†‡§µ‡§≤‡•Ä! ‚úÖ");
        } catch (e) { 
            alert("Permission Error: ‡§´‡§æ‡§Ø‡§∞‡§¨‡•á‡§∏ Rules ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡§æ!"); 
        }
    };

    // ‡§´‡•ã‡§ü‡•ã ‡§¨‡§¶‡§≤‡§£‡•á
    document.getElementById('profileTrigger').onclick = () => document.getElementById('fileInput').click();
    document.getElementById('fileInput').onchange = e => {
        const r = new FileReader();
        r.onload = () => {
            profilePic.src = r.result;
            localStorage.setItem("prof_photo", r.result);
        };
        r.readAsDataURL(e.target.files[0]);
    };

    // ‡§≤‡•â‡§ó‡§Ü‡§â‡§ü ‡§Ü‡§£‡§ø ‡§°‡§ø‡§≤‡•Ä‡§ü
    document.getElementById('logoutBtn').onclick = () => {
        if(confirm("‡§≤‡•â‡§ó‡§Ü‡§â‡§ü ‡§ï‡§∞‡§æ‡§Ø‡§ö‡•á?")) {
            signOut(auth).then(() => {
                sessionStorage.removeItem("isLoggedIn");
                window.location.replace("index.html");
            });
        }
    };

    document.getElementById('deleteBtn').onclick = () => {
        const user = auth.currentUser;
        if(user && confirm("‡§ñ‡§æ‡§§‡•á ‡§ï‡§æ‡§Ø‡§Æ‡§ö‡•á ‡§π‡§ü‡§µ‡§æ‡§Ø‡§ö‡•á ‡§ï‡§æ?")) {
            deleteUser(user).then(() => {
                localStorage.clear(); sessionStorage.clear();
                window.location.replace("index.html");
            }).catch(() => alert("‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡•á‡§∏‡§æ‡§†‡•Ä ‡§™‡•Å‡§®‡•ç‡§π‡§æ ‡§≤‡•â‡§ó‡§ø‡§® ‡§ï‡§∞‡§æ."));
        }
    };

    function showToast(m) {
        toast.innerText = m; toast.style.display = "block";
        setTimeout(() => toast.style.display = "none", 2500);
    }
</script>

</body>
</html>
