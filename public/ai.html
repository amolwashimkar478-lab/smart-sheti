<!DOCTYPE html>
<html lang="mr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Smart Sheti AI - Expert Advice</title>

<style>
  * { box-sizing: border-box; }
  body { 
    margin: 0; background: #f0f2f5; font-family: 'Segoe UI', Arial, sans-serif; 
    height: 100vh; display: flex; flex-direction: column; 
  }

  /* HEADER */
  header {
    background: #1b5e20; color: #fff; padding: 15px; display: flex; align-items: center;
    font-size: 20px; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 20;
  }
  .menuBtn { font-size: 24px; cursor: pointer; margin-right: 15px; }

  /* SIDE MENU */
  #sideMenu {
    position: fixed; top: 0; left: -280px; width: 280px; height: 100%; background: white;
    padding: 20px; box-shadow: 4px 0 15px rgba(0,0,0,0.2); transition: 0.3s; overflow-y: auto; z-index: 30;
  }
  #sideMenu.show { left: 0; }
  #sideMenu h3 { color: #1b5e20; border-bottom: 2px solid #eee; padding-bottom: 10px; }

  .history-item {
    padding: 12px; border-bottom: 1px solid #f0f0f0; cursor: pointer;
    font-size: 14px; color: #333; transition: background 0.2s;
  }
  .history-item:hover { background: #f9f9f9; }

  /* OVERLAY */
  #overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.5); display: none; z-index: 25;
  }

  /* CHAT AREA */
  #chatBox { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; }
  
  .msg { max-width: 85%; padding: 12px 16px; border-radius: 18px; font-size: 15px; line-height: 1.5; position: relative; }
  .user { background: #dcf8c6; align-self: flex-end; border-bottom-right-radius: 2px; color: #000; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
  .ai { background: #ffffff; align-self: flex-start; border-bottom-left-radius: 2px; color: #333; border: 1px solid #e0e0e0; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }

  .chat-img { max-width: 100%; border-radius: 10px; margin-bottom: 8px; display: block; border: 1px solid #ddd; }

  /* INPUT BAR */
  #inputBar { display: flex; gap: 10px; padding: 12px; background: #fff; border-top: 1px solid #ddd; align-items: center; }
  #userInput { flex: 1; padding: 12px 18px; border-radius: 30px; border: 1px solid #ccc; outline: none; font-size: 15px; }
  #userInput:focus { border-color: #1b5e20; }

  .iconBtn {
    background: #1b5e20; border: none; color: #fff; width: 45px; height: 45px;
    border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 20px; flex-shrink: 0;
  }
  .cameraBtn { background: #555; }
  .sendBtn { background: #1565c0; }

  /* LOADING SPINNER */
  .typing { font-style: italic; color: #777; font-size: 13px; margin-left: 5px; }
</style>
</head>

<body>

<header>
  <span class="menuBtn" onclick="toggleMenu()">‚ò∞</span>
  üåø ‡§°‡§ø‡§ú‡§ø‡§ü‡§≤ ‡§∂‡•á‡§§‡•Ä ‡§Æ‡§ø‡§§‡•ç‡§∞
</header>

<div id="overlay" onclick="closeMenu()"></div>

<div id="sideMenu">
  <h3>üìú ‡§ú‡•Å‡§®‡•Ä ‡§ö‡§∞‡•ç‡§ö‡§æ</h3>
  <div id="historyList"></div>
  <button onclick="clearHistory()" style="margin-top:20px; background:#c62828; color:white; border:none; width:100%; padding:10px; border-radius:5px; cursor:pointer;">üóëÔ∏è ‡§π‡§ø‡§∏‡•ç‡§ü‡•ç‡§∞‡•Ä ‡§™‡•Å‡§∏‡§æ</button>
</div>

<div id="chatBox">
  <div class="msg ai">‡§®‡§Æ‡§∏‡•ç‡§ï‡§æ‡§∞! ‡§Æ‡•Ä ‡§Ü‡§™‡§≤‡§æ AI ‡§∂‡•á‡§§‡•Ä ‡§∏‡§≤‡•ç‡§≤‡§æ‡§ó‡§æ‡§∞ ‡§Ü‡§π‡•á. ‡§§‡•Å‡§Æ‡•ç‡§π‡•Ä ‡§Æ‡§≤‡§æ ‡§ï‡•ã‡§£‡§§‡§æ‡§π‡•Ä ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§µ‡§ø‡§ö‡§æ‡§∞‡•Ç ‡§∂‡§ï‡§§‡§æ ‡§ï‡§ø‡§Ç‡§µ‡§æ ‡§™‡§ø‡§ï‡§æ‡§ö‡•ç‡§Ø‡§æ ‡§∞‡•ã‡§ó‡§æ‡§ö‡§æ ‡§´‡•ã‡§ü‡•ã ‡§™‡§æ‡§†‡§µ‡•Ç ‡§∂‡§ï‡§§‡§æ.</div>
</div>

<div id="inputBar">
  <input type="file" id="fileInput" accept="image/*" style="display:none" onchange="processFile(event)">
  <button class="iconBtn cameraBtn" onclick="document.getElementById('fileInput').click()">üì∑</button>
  
  <input id="userInput" placeholder="‡§Ø‡•á‡§•‡•á ‡§Æ‡•á‡§∏‡•á‡§ú ‡§≤‡§ø‡§π‡§æ..." onkeypress="if(event.key==='Enter') sendText()">
  <button class="iconBtn sendBtn" onclick="sendText()">‚û§</button>
</div>

<script>
const chatBox = document.getElementById("chatBox");
const userInput = document.getElementById("userInput");
let history = JSON.parse(localStorage.getItem("agriChat") || "[]");

/* --- UI Logic --- */
function toggleMenu() {
  document.getElementById("sideMenu").classList.toggle("show");
  document.getElementById("overlay").style.display = document.getElementById("sideMenu").classList.contains("show") ? "block" : "none";
  renderHistory();
}

function closeMenu() {
  document.getElementById("sideMenu").classList.remove("show");
  document.getElementById("overlay").style.display = "none";
}

function addMessage(text, sender, imgSrc = null) {
  const div = document.createElement("div");
  div.className = `msg ${sender}`;
  
  if(imgSrc) {
    const img = document.createElement("img");
    img.src = imgSrc;
    img.className = "chat-img";
    div.appendChild(img);
  }

  const span = document.createElement("span");
  span.innerText = text;
  div.appendChild(span);
  
  chatBox.appendChild(div);
  chatBox.scrollTop = chatBox.scrollHeight;
  return div;
}

/* --- Sending Logic --- */
async function sendText() {
  const text = userInput.value.trim();
  if(!text) return;

  addMessage(text, "user");
  userInput.value = "";

  const aiMsgDiv = addMessage("‚è≥ ‡§µ‡§ø‡§ö‡§æ‡§∞ ‡§ï‡§∞‡§§ ‡§Ü‡§π‡•á...", "ai");

  try {
    const res = await fetch("/api/disease", { // ‡§§‡•Å‡§Æ‡§ö‡•ç‡§Ø‡§æ Backend ‡§´‡§æ‡§à‡§≤‡§ö‡•á ‡§®‡§æ‡§µ ‡§§‡§™‡§æ‡§∏‡§æ
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ prompt: text, city: "Maharashtra" })
    });
    const data = await res.json();
    aiMsgDiv.innerText = data.reply;
    saveToHistory(text, data.reply);
  } catch (err) {
    aiMsgDiv.innerText = "Error: ‡§∏‡§∞‡•ç‡§µ‡•ç‡§π‡§∞‡§∂‡•Ä ‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï ‡§ù‡§æ‡§≤‡§æ ‡§®‡§æ‡§π‡•Ä.";
  }
}

/* --- Image Processing --- */
function processFile(event) {
  const file = event.target.files[0];
  if(!file) return;

  const reader = new FileReader();
  reader.onload = function(e) {
    const img = new Image();
    img.src = e.target.result;
    img.onload = function() {
      const canvas = document.createElement('canvas');
      const ctx = canvas.width = 800; // ‡§´‡•ã‡§ü‡•ã ‡§∞‡§ø‡§∏‡§æ‡§à‡§ú
      const scale = 800 / img.width;
      canvas.width = 800;
      canvas.height = img.height * scale;
      canvas.getContext('2d').drawImage(img, 0, 0, canvas.width, canvas.height);
      
      const compressedBase64 = canvas.toDataURL('image/jpeg', 0.7);
      uploadPhoto(compressedBase64);
    };
  };
  reader.readAsDataURL(file);
}

async function uploadPhoto(base64) {
  addMessage("‡§´‡•ã‡§ü‡•ã ‡§§‡§™‡§æ‡§∏‡§£‡•Ä‡§∏‡§æ‡§†‡•Ä ‡§™‡§æ‡§†‡§µ‡§≤‡§æ ‡§Ü‡§π‡•á...", "user", base64);
  const aiMsgDiv = addMessage("‚è≥ AI ‡§´‡•ã‡§ü‡•ã‡§ö‡§æ ‡§Ö‡§≠‡•ç‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡§§ ‡§Ü‡§π‡•á...", "ai");

  try {
    const res = await fetch("/api/disease", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ 
        image: base64.split(",")[1], 
        city: "Maharashtra" 
      })
    });
    const data = await res.json();
    aiMsgDiv.innerText = data.reply;
  } catch (err) {
    aiMsgDiv.innerText = "‡§´‡•ã‡§ü‡•ã ‡§§‡§™‡§æ‡§∏‡§§‡§æ‡§®‡§æ ‡§è‡§∞‡§∞ ‡§Ü‡§≤‡§æ.";
  }
}

/* --- History Logic --- */
function saveToHistory(q, a) {
  history.unshift({ q, a });
  localStorage.setItem("agriChat", JSON.stringify(history.slice(0, 15)));
}

function renderHistory() {
  const list = document.getElementById("historyList");
  list.innerHTML = "";
  history.forEach((item, i) => {
    const div = document.createElement("div");
    div.className = "history-item";
    div.innerText = "üí¨ " + item.q.substring(0, 25) + "...";
    div.onclick = () => {
      chatBox.innerHTML = "";
      addMessage(item.q, "user");
      addMessage(item.a, "ai");
      closeMenu();
    };
    list.appendChild(div);
  });
}

function clearHistory() {
  if(confirm("‡§π‡§ø‡§∏‡•ç‡§ü‡•ç‡§∞‡•Ä ‡§ï‡§æ‡§Ø‡§Æ‡§ö‡•Ä ‡§™‡•Å‡§∏‡§æ‡§Ø‡§ö‡•Ä ‡§ï‡§æ?")) {
    localStorage.removeItem("agriChat");
    history = [];
    renderHistory();
  }
}
</script>
</body>
</html>

