<!DOCTYPE html>
<html lang="mr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Smart Sheti AI</title>

<style>
*{box-sizing:border-box;}
body{
  margin:0;background:#e8f5e9;font-family:Arial,sans-serif;height:100vh;display:flex;flex-direction:column;
}

/* HEADER */
header{
  background:#2e7d32;color:#fff;padding:14px;display:flex;align-items:center;
  font-size:18px;gap:12px;position:relative;z-index:20;
}
.menuBtn{font-size:22px;cursor:pointer;}

/* SIDE MENU */
#sideMenu{
  position:fixed;top:0;left:-260px;width:260px;height:100%;background:#ffffff;
  padding:14px;box-shadow:2px 0 8px rgba(0,0,0,0.2);transition:0.3s;z-index:30;
  display: flex; flex-direction: column;
}
#sideMenu.show{left:0;}

.new-chat-btn {
  background: #2e7d32; color: white; border: none; padding: 12px;
  border-radius: 8px; margin: 10px; cursor: pointer; font-weight: bold;
}

#historyList { flex: 1; overflow-y: auto; }

.history-item{
  padding:12px;border-bottom:1px solid #eee;cursor:pointer;
  display:flex;justify-content:space-between;align-items:center;
  user-select: none; font-size: 14px;
}

/* Options Popup */
.history-actions{
  position:fixed;bottom:30px;left:50%;transform:translateX(-50%);
  width:220px;background:#fff;border-radius:12px;
  display:none;z-index:100;box-shadow: 0 5px 20px rgba(0,0,0,0.3); overflow: hidden;
}
.history-actions button{
  background:none;border:none;padding:12px;text-align:left;font-size:15px;width:100%; border-bottom: 1px solid #f0f0f0;
}

/* DARK OVERLAY */
#overlay{
  position:fixed;top:0;left:0;width:100%;height:100%;
  background:rgba(0,0,0,0.45);display:none;z-index:25;
}

/* CHAT AREA */
#chatBox{flex:1;padding:12px;overflow-y:auto; display: flex; flex-direction: column;}
.user,.ai{
  max-width:85%;padding:10px 14px;margin:6px 0;border-radius:15px;font-size:15px;line-height:1.4;
}
.user{background:#c8e6c9;align-self: flex-end; border-bottom-right-radius: 2px;}
.ai{background:#fff;border:1px solid #ddd; align-self: flex-start; border-bottom-left-radius: 2px; white-space: pre-wrap;}
.chat-img { max-width: 100%; border-radius: 8px; margin-top: 5px; display: block;}

/* INPUT BAR */
#inputBar{
  display:flex;gap:6px;padding:10px;background:#fff;border-top:1px solid #ccc;align-items: center;
}
#inputBar input{
  flex:1;padding:12px;border-radius:25px;border:1px solid #ccc;outline: none;
}
.iconBtn{
  background:#2e7d32;border:none;color:#fff;width:42px;height:42px;border-radius:50%; cursor: pointer; display: flex; align-items: center; justify-content: center;
}
.sendBtn{background:#1565c0;}
</style>
</head>

<body>

<header>
  <span class="menuBtn" onclick="toggleMenu()">‚ò∞</span>
  ü§ñ ‡§∂‡•á‡§§‡§ï‡§∞‡•Ä AI ‡§Æ‡§ø‡§§‡•ç‡§∞
</header>

<div id="overlay" onclick="closeMenu(); hideOptions();"></div>

<div id="sideMenu">
  <h3 style="padding-left:14px;">üìú ‡§ö‡§∞‡•ç‡§ö‡§æ ‡§á‡§§‡§ø‡§π‡§æ‡§∏</h3>
  <button class="new-chat-btn" onclick="startNewChat()">+ ‡§®‡§µ‡•Ä‡§® ‡§ö‡•Ö‡§ü ‡§∏‡•Å‡§∞‡•Ç ‡§ï‡§∞‡§æ</button>
  <div id="historyList"></div>
  <button onclick="clearAllHistory()" style="background:none; border:none; color:red; cursor:pointer; padding:15px; text-align: left;">üóëÔ∏è ‡§∏‡§∞‡•ç‡§µ ‡§°‡§ø‡§≤‡•Ä‡§ü ‡§ï‡§∞‡§æ</button>
</div>

<div id="optionBox" class="history-actions"></div>

<div id="chatBox"></div>

<div id="inputBar">
  <input type="file" id="imageInput" accept="image/*" hidden onchange="handleImage(event)">
  <button class="iconBtn" onclick="document.getElementById('imageInput').click()">üì∑</button>
  
  <input id="userInput" placeholder="‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§≤‡§ø‡§π‡§æ..." onkeypress="if(event.key==='Enter') sendMessage()">
  <button class="iconBtn sendBtn" onclick="sendMessage()">‚û§</button>
</div>

<script>
const chatBox = document.getElementById("chatBox");
const input = document.getElementById("userInput");
let history = JSON.parse(localStorage.getItem("chatHistory") || "[]");
let currentChatIndex = null;
let pressTimer;

// ‡§∏‡•Å‡§∞‡•Å‡§µ‡§æ‡§§‡•Ä‡§≤‡§æ ‡§ú‡•Å‡§®‡•Ä ‡§π‡§ø‡§∏‡•ç‡§ü‡•ç‡§∞‡•Ä ‡§∞‡•á‡§Ç‡§°‡§∞ ‡§ï‡§∞‡§£‡•á
renderHistory();
startNewChat();

function toggleMenu(){
  const menu = document.getElementById("sideMenu");
  const overlay = document.getElementById("overlay");
  menu.classList.toggle("show");
  overlay.style.display = menu.classList.contains("show") ? "block" : "none";
}

function closeMenu(){
  document.getElementById("sideMenu").classList.remove("show");
  document.getElementById("overlay").style.display="none";
}

function hideOptions() { document.getElementById("optionBox").style.display = "none"; }

/* ---------------- NEW CHAT ---------------- */
function startNewChat() {
  currentChatIndex = null;
  chatBox.innerHTML = '<div class="ai">‡§®‡§Æ‡§∏‡•ç‡§ï‡§æ‡§∞! ‡§Æ‡•Ä ‡§§‡•Å‡§Æ‡•ç‡§π‡§æ‡§≤‡§æ ‡§ï‡§æ‡§Ø ‡§Æ‡§¶‡§§ ‡§ï‡§∞‡•Ç ‡§∂‡§ï‡§§‡•ã? ‡§∂‡•á‡§§‡•Ä‡§µ‡§ø‡§∑‡§Ø‡§ï ‡§ï‡•ã‡§£‡§§‡§æ‡§π‡•Ä ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§µ‡§ø‡§ö‡§æ‡§∞‡§æ ‡§ï‡§ø‡§Ç‡§µ‡§æ ‡§´‡•ã‡§ü‡•ã ‡§™‡§æ‡§†‡§µ‡§æ.</div>';
  input.value = "";
  closeMenu();
}

/* ---------------- SEND MESSAGE ---------------- */
async function sendMessage(imageData = null){
  const text = input.value.trim();
  if(!text && !imageData) return;

  // ‡§Ø‡•Å‡§ú‡§∞‡§ö‡§æ ‡§Æ‡•á‡§∏‡•á‡§ú ‡§¶‡§æ‡§ñ‡§µ‡§æ
  addMessage(text || "üì∑ ‡§´‡•ã‡§ü‡•ã ‡§§‡§™‡§æ‡§∏‡§§ ‡§Ü‡§π‡•á...", "user", imageData);
  input.value = "";

  // ‡§ú‡§∞ ‡§®‡§µ‡•Ä‡§® ‡§ö‡•Ö‡§ü ‡§Ö‡§∏‡•á‡§≤ ‡§§‡§∞ ‡§π‡§ø‡§∏‡•ç‡§ü‡•ç‡§∞‡•Ä‡§Æ‡§ß‡•ç‡§Ø‡•á ‡§ú‡§æ‡§ó‡§æ ‡§¨‡§®‡§µ‡§æ
  if (currentChatIndex === null) {
    const newEntry = { title: text || "‡§´‡•ã‡§ü‡•ã ‡§ö‡§∞‡•ç‡§ö‡§æ", messages: [] };
    history.unshift(newEntry);
    currentChatIndex = 0;
  }
  history[currentChatIndex].messages.push({t: text || "üì∑ ‡§´‡•ã‡§ü‡•ã", c: "user", img: imageData});

  const aiLoading = addMessage("‚è≥ ‡§µ‡§ø‡§ö‡§æ‡§∞ ‡§ï‡§∞‡§§ ‡§Ü‡§π‡•á...", "ai");

  try {
    const res = await fetch("/api/chat", { // ‡§§‡•Å‡§Æ‡§ö‡•ç‡§Ø‡§æ API ‡§´‡§æ‡§à‡§≤‡§ö‡§æ ‡§Ö‡§ö‡•Ç‡§ï ‡§™‡§§‡•ç‡§§‡§æ ‡§á‡§•‡•á ‡§ü‡§æ‡§ï‡§æ (‡§â‡§¶‡§æ. /api/chat ‡§ï‡§ø‡§Ç‡§µ‡§æ /api/disease)
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ 
        prompt: text, 
        image: imageData // ‡§¨‡•á‡§∏‡•¨‡•™ ‡§°‡•á‡§ü‡§æ ‡§ú‡§æ‡§§‡•ã‡§Ø
      })
    });

    const data = await res.json();
    const reply = data.reply || "‡§â‡§§‡•ç‡§§‡§∞ ‡§Æ‡§ø‡§≥‡§æ‡§≤‡•á ‡§®‡§æ‡§π‡•Ä.";
    
    aiLoading.innerText = reply;
    
    // AI ‡§â‡§§‡•ç‡§§‡§∞ ‡§π‡§ø‡§∏‡•ç‡§ü‡•ç‡§∞‡•Ä‡§Æ‡§ß‡•ç‡§Ø‡•á ‡§∏‡•á‡§µ‡•ç‡§π ‡§ï‡§∞‡§æ
    history[currentChatIndex].messages.push({t: reply, c: "ai"});
    save();
  } catch (err) {
    aiLoading.innerText = "‚ùå ‡§∏‡§∞‡•ç‡§µ‡•ç‡§π‡§∞‡§∂‡•Ä ‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï ‡§π‡•ã‡§ä ‡§∂‡§ï‡§≤‡§æ ‡§®‡§æ‡§π‡•Ä.";
  }
}

function addMessage(t, c, img = null) {
  const d = document.createElement("div");
  d.className = c;
  if(img) {
    const i = document.createElement("img");
    i.src = img;
    i.className = "chat-img";
    d.appendChild(i);
  }
  const s = document.createElement("span");
  s.innerText = t;
  d.appendChild(s);
  chatBox.appendChild(d);
  chatBox.scrollTop = chatBox.scrollHeight;
  return s;
}

/* ---------------- HISTORY LOGIC ---------------- */
function save() {
  localStorage.setItem("chatHistory", JSON.stringify(history));
  renderHistory();
}

function renderHistory() {
  const box = document.getElementById("historyList");
  box.innerHTML = "";
  history.forEach((h, i) => {
    const div = document.createElement("div");
    div.className = "history-item";
    div.innerText = "üí¨ " + h.title.slice(0, 20) + "...";
    
    // ‡§∏‡§ø‡§Ç‡§ó‡§≤ ‡§ï‡•ç‡§≤‡§ø‡§ï - ‡§ö‡•Ö‡§ü ‡§â‡§ò‡§°‡§£‡•á
    div.onclick = () => loadChat(i);

    // ‡§≤‡§æ‡§Å‡§ó ‡§™‡•ç‡§∞‡•á‡§∏ - ‡§ë‡§™‡•ç‡§∂‡§®‡•ç‡§∏ ‡§â‡§ò‡§°‡§£‡•á
    div.onmousedown = div.ontouchstart = () => { pressTimer = setTimeout(() => openOptions(i), 600); };
    div.onmouseup = div.ontouchend = () => clearTimeout(pressTimer);

    box.appendChild(div);
  });
}

function loadChat(i) {
  currentChatIndex = i;
  chatBox.innerHTML = "";
  history[i].messages.forEach(m => addMessage(m.t, m.c, m.img));
  closeMenu();
}

function openOptions(i) {
  const menu = document.getElementById("optionBox");
  menu.style.display = "block";
  document.getElementById("overlay").style.display = "block";
  menu.innerHTML = `
    <button onclick="renameChat(${i})">‚úèÔ∏è ‡§®‡§æ‡§µ ‡§¨‡§¶‡§≤‡§æ</button>
    <button onclick="deleteChat(${i})" style="color:red;">üóëÔ∏è ‡§ö‡•Ö‡§ü ‡§π‡§ü‡§µ‡§æ</button>
    <button onclick="hideOptions()">‚ùå ‡§∞‡§¶‡•ç‡§¶ ‡§ï‡§∞‡§æ</button>
  `;
}

function renameChat(i) {
  let n = prompt("‡§®‡§µ‡•Ä‡§® ‡§®‡§æ‡§µ ‡§¶‡•ç‡§Ø‡§æ:", history[i].title);
  if(n) { history[i].title = n; save(); }
  hideOptions();
}

function deleteChat(i) {
  if(confirm("‡§π‡§æ ‡§ö‡•Ö‡§ü ‡§π‡§ü‡§µ‡§æ‡§Ø‡§ö‡§æ?")) {
    history.splice(i, 1);
    startNewChat();
    save();
  }
  hideOptions();
}

function clearAllHistory() {
  if(confirm("‡§∏‡§∞‡•ç‡§µ ‡§°‡•á‡§ü‡§æ ‡§™‡•Å‡§∏‡§æ‡§Ø‡§ö‡§æ?")) { history = []; save(); startNewChat(); }
}

/* ---------------- IMAGE HANDLING ---------------- */
function handleImage(event) {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = (e) => {
    const base64 = e.target.result; // ‡§Ø‡§æ‡§Æ‡§ß‡•ç‡§Ø‡•á "data:image/jpeg;base64,..." ‡§™‡•Ç‡§∞‡•ç‡§£ ‡§∏‡•ç‡§ü‡•ç‡§∞‡§ø‡§Ç‡§ó ‡§Ö‡§∏‡§§‡•á
    sendMessage(base64);
  };
  reader.readAsDataURL(file);
}
</script>
</body>
</html>
