<!DOCTYPE html>
<html lang="mr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Smart Sheti - AI</title>
  <style>
    /* 1. Global Styles */
    * { box-sizing: border-box; }
    body {
      margin: 0; background: #e8f5e9; font-family: 'Segoe UI', Arial, sans-serif;
      height: 100vh; display: flex; flex-direction: column; overflow: hidden;
    }

    /* 2. Header */
    header {
      background: #2e7d32; color: #fff; padding: 14px; display: flex;
      align-items: center; font-size: 18px; gap: 12px; z-index: 20; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .menuBtn { font-size: 24px; cursor: pointer; }

    /* 3. Side Menu (History) */
    #sideMenu {
      position: fixed; top: 0; left: -280px; width: 280px; height: 100%;
      background: #ffffff; padding: 20px 15px; box-shadow: 4px 0 10px rgba(0,0,0,0.2);
      transition: 0.3s; z-index: 100; overflow-y: auto; display: flex; flex-direction: column;
    }
    #sideMenu.show { left: 0; }
    #sideMenu h3 { margin-top: 0; color: #2e7d32; border-bottom: 2px solid #eee; padding-bottom: 10px; }
    
    .new-chat-btn {
      background: #2e7d32; color: white; border: none; padding: 12px;
      border-radius: 8px; margin-bottom: 15px; cursor: pointer; font-weight: bold;
    }

    .history-item {
      padding: 12px; border-bottom: 1px solid #f0f0f0; cursor: pointer;
      display: flex; flex-direction: column; gap: 4px; user-select: none;
    }
    .history-item:active { background: #f0f0f0; }
    .history-item span { font-size: 14px; color: #333; }
    .history-item small { font-size: 11px; color: #888; }

    /* 4. Chat Area */
    #chatBox { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
    .user, .ai {
      max-width: 85%; padding: 10px 14px; border-radius: 15px; font-size: 15px; line-height: 1.5;
    }
    .user { background: #c8e6c9; align-self: flex-end; border-bottom-right-radius: 2px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
    .ai { background: #ffffff; border: 1px solid #ddd; align-self: flex-start; border-bottom-left-radius: 2px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
    .chat-img { max-width: 100%; border-radius: 10px; margin-bottom: 5px; display: block; }

    /* 5. Preview & Actions */
    #previewBox {
      display: none; padding: 10px; background: #fff; border-top: 1px solid #ddd;
      align-items: center; gap: 12px;
    }
    #previewImg { width: 50px; height: 50px; object-fit: cover; border-radius: 8px; border: 1px solid #ccc; }
    
    .history-actions {
      position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
      width: 220px; background: #fff; border-radius: 15px; display: none;
      z-index: 110; box-shadow: 0 5px 25px rgba(0,0,0,0.3); overflow: hidden;
    }
    .history-actions button {
      background: none; border: none; padding: 14px; text-align: left;
      font-size: 15px; width: 100%; border-bottom: 1px solid #eee; cursor: pointer;
    }

    /* 6. Input Bar */
    #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.45); display: none; z-index: 90; }
    #inputBar { display: flex; gap: 8px; padding: 10px; background: #fff; border-top: 1px solid #ddd; align-items: center; }
    #userInput { flex: 1; padding: 12px 15px; border-radius: 25px; border: 1px solid #ccc; outline: none; font-size: 15px; }
    .iconBtn { background: #2e7d32; border: none; color: #fff; width: 42px; height: 42px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; flex-shrink: 0; }
    .sendBtn { background: #1565c0; }
  </style>
</head>

<body>

<header>
  <span class="menuBtn" onclick="toggleMenu()">‚ò∞</span>
  ü§ñ ‡§∂‡•á‡§§‡§ï‡§∞‡•Ä AI ‡§Æ‡§ø‡§§‡•ç‡§∞
</header>

<div id="overlay" onclick="closeAll()"></div>

<div id="sideMenu">
  <h3>üìú ‡§ö‡§∞‡•ç‡§ö‡§æ ‡§á‡§§‡§ø‡§π‡§æ‡§∏</h3>
  <button class="new-chat-btn" onclick="startNewChat()">+ ‡§®‡§µ‡•Ä‡§® ‡§ö‡•Ö‡§ü</button>
  <input id="searchHistory" oninput="filterHistory()" placeholder="‡§ö‡•Ö‡§ü ‡§∂‡•ã‡§ß‡§æ..." style="width:100%;padding:10px;border:1px solid #ddd;border-radius:20px;margin-bottom:15px; outline:none;">
  <div id="historyList"></div>
  <button onclick="clearAllHistory()" style="margin-top:auto; background:none; color:#d32f2f; padding:10px; border:none; cursor:pointer; font-weight:bold;">üóëÔ∏è ‡§∏‡§∞‡•ç‡§µ ‡§π‡§ø‡§∏‡•ç‡§ü‡•ç‡§∞‡•Ä ‡§™‡•Å‡§∏‡§æ</button>
</div>

<div id="optionBox" class="history-actions"></div>

<div id="chatBox">
  <div class="ai">‡§®‡§Æ‡§∏‡•ç‡§ï‡§æ‡§∞! ‡§Æ‡•Ä ‡§Ü‡§™‡§≤‡§æ AI ‡§∂‡•á‡§§‡•Ä ‡§∏‡§≤‡•ç‡§≤‡§æ‡§ó‡§æ‡§∞ ‡§Ü‡§π‡•á. ‡§§‡•Å‡§Æ‡•ç‡§π‡•Ä ‡§Æ‡§≤‡§æ ‡§ï‡•ã‡§£‡§§‡§æ‡§π‡•Ä ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§µ‡§ø‡§ö‡§æ‡§∞‡•Ç ‡§∂‡§ï‡§§‡§æ ‡§ï‡§ø‡§Ç‡§µ‡§æ ‡§™‡§ø‡§ï‡§æ‡§ö‡§æ ‡§´‡•ã‡§ü‡•ã ‡§™‡§æ‡§†‡§µ‡•Ç ‡§∂‡§ï‡§§‡§æ.</div>
</div>

<div id="previewBox">
  <img id="previewImg" src="">
  <span style="font-size: 13px; color: #555; flex: 1;">‡§´‡•ã‡§ü‡•ã ‡§Ö‡§™‡§≤‡•ã‡§°‡§∏‡§æ‡§†‡•Ä ‡§§‡§Ø‡§æ‡§∞...</span>
  <button onclick="cancelImage()" style="background:none; border:none; font-size:24px; color:#d32f2f; cursor:pointer;">&times;</button>
</div>

<div id="inputBar">
  <button class="iconBtn" onclick="openCamera()">üì∑</button>
  <button class="iconBtn" onclick="openGallery()">üñºÔ∏è</button>
  <input id="userInput" placeholder="‡§Ø‡•á‡§•‡•á ‡§Æ‡•á‡§∏‡•á‡§ú ‡§≤‡§ø‡§π‡§æ..." onkeypress="if(event.key==='Enter') sendMessage()">
  <button class="iconBtn sendBtn" onclick="sendMessage()">‚û§</button>

  <input type="file" id="cameraInput" accept="image/*" capture="environment" hidden onchange="handleFile(this)">
  <input type="file" id="galleryInput" accept="image/*" hidden onchange="handleFile(this)">
</div>

<script>
  const chatBox = document.getElementById("chatBox");
  const userInput = document.getElementById("userInput");
  let selectedImage = null;
  let currentChatIndex = null;
  let pressTimer;

  // Load History
  let history = JSON.parse(localStorage.getItem("chatHistory") || "[]");
  renderHistory();

  /* --- Navigation Logic --- */
  function toggleMenu() {
    const menu = document.getElementById("sideMenu");
    const overlay = document.getElementById("overlay");
    menu.classList.toggle("show");
    overlay.style.display = menu.classList.contains("show") ? "block" : "none";
  }

  function closeAll() {
    document.getElementById("sideMenu").classList.remove("show");
    document.getElementById("overlay").style.display = "none";
    hideOptions();
  }

  function startNewChat() {
    currentChatIndex = null;
    chatBox.innerHTML = '<div class="ai">‡§®‡§µ‡•Ä‡§® ‡§ö‡•Ö‡§ü ‡§∏‡•Å‡§∞‡•Ç ‡§ù‡§æ‡§≤‡•á ‡§Ü‡§π‡•á. ‡§µ‡§ø‡§ö‡§æ‡§∞‡§æ ‡§§‡•Å‡§Æ‡§ö‡§æ ‡§™‡•ç‡§∞‡§∂‡•ç‡§®!</div>';
    closeAll();
  }

  /* --- Image Logic --- */
  function openCamera() { document.getElementById("cameraInput").click(); }
  function openGallery() { document.getElementById("galleryInput").click(); }

  function handleFile(input) {
    const file = input.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        selectedImage = e.target.result;
        document.getElementById("previewImg").src = selectedImage;
        document.getElementById("previewBox").style.display = "flex";
      };
      reader.readAsDataURL(file);
    }
  }

  function cancelImage() {
    selectedImage = null;
    document.getElementById("previewBox").style.display = "none";
    document.querySelectorAll('input[type="file"]').forEach(i => i.value = "");
  }

  /* --- Messaging Logic --- */
  async function sendMessage() {
    const text = userInput.value.trim();
    if (!text && !selectedImage) return;

    // 1. Show User Message
    const userDiv = document.createElement("div");
    userDiv.className = "user";
    if (selectedImage) userDiv.innerHTML += `<img src="${selectedImage}" class="chat-img">`;
    if (text) userDiv.innerHTML += `<span>${text}</span>`;
    chatBox.appendChild(userDiv);
    chatBox.scrollTop = chatBox.scrollHeight;

    // 2. Manage History
    if (currentChatIndex === null) {
      const newEntry = {
        txt: text || "‡§´‡•ã‡§ü‡•ã ‡§ö‡§∞‡•ç‡§ö‡§æ",
        messages: [{ t: text, img: selectedImage, c: "user" }],
        date: new Date().toLocaleString()
      };
      history.unshift(newEntry);
      currentChatIndex = 0;
    } else {
      history[currentChatIndex].messages.push({ t: text, img: selectedImage, c: "user" });
    }

    const imageToSend = selectedImage;
    cancelImage();
    userInput.value = "";

    // 3. AI Response
    const aiLoader = addMsg("‚è≥ ‡§µ‡§ø‡§ö‡§æ‡§∞ ‡§ï‡§∞‡§§ ‡§Ü‡§π‡•á...", "ai", "loader");

    try {
      const res = await fetch("/api/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ prompt: text, image: imageToSend })
      });
      const data = await res.json();
      aiLoader.remove();
      
      const reply = data.reply || "‡§ï‡•ç‡§∑‡§Æ‡§∏‡•ç‡§µ, ‡§â‡§§‡•ç‡§§‡§∞ ‡§Æ‡§ø‡§≥‡§æ‡§≤‡•á ‡§®‡§æ‡§π‡•Ä.";
      addMsg(reply, "ai");
      
      // Save AI Response to History
      history[currentChatIndex].messages.push({ t: reply, c: "ai" });
      save();

    } catch (err) {
      aiLoader.innerText = "‚ùå ‡§∏‡§∞‡•ç‡§µ‡•ç‡§π‡§∞ ‡§è‡§∞‡§∞. ‡§™‡•Å‡§®‡•ç‡§π‡§æ ‡§™‡•ç‡§∞‡§Ø‡§§‡•ç‡§® ‡§ï‡§∞‡§æ.";
    }
  }

  function addMsg(text, className, id = "") {
    const d = document.createElement("div");
    d.className = className;
    if (id) d.id = id;
    d.innerText = text;
    chatBox.appendChild(d);
    chatBox.scrollTop = chatBox.scrollHeight;
    return d;
  }

  /* --- History Logic --- */
  function save() {
    localStorage.setItem("chatHistory", JSON.stringify(history));
    renderHistory();
  }

  function renderHistory(list = history) {
    const box = document.getElementById("historyList");
    box.innerHTML = "";
    list.forEach((h, i) => {
      const div = document.createElement("div");
      div.className = "history-item";
      div.innerHTML = `
        <span>${h.pin ? "üìå" : "üí¨"} ${h.txt.slice(0, 22)}...</span>
        <small>${h.date}</small>`;
      
      // Click: Load Chat
      div.onclick = () => loadChat(i);
      
      // Long Press: Options
      div.onmousedown = div.ontouchstart = () => { pressTimer = setTimeout(() => openOptions(i), 600); };
      div.onmouseup = div.ontouchend = () => clearTimeout(pressTimer);
      
      box.appendChild(div);
    });
  }

  function loadChat(i) {
    currentChatIndex = i;
    chatBox.innerHTML = "";
    history[i].messages.forEach(m => {
      const d = document.createElement("div");
      d.className = m.c;
      if (m.img) d.innerHTML += `<img src="${m.img}" class="chat-img">`;
      if (m.t) d.innerHTML += `<span>${m.t}</span>`;
      chatBox.appendChild(d);
    });
    chatBox.scrollTop = chatBox.scrollHeight;
    closeAll();
  }

  function openOptions(i) {
    const menu = document.getElementById("optionBox");
    menu.style.display = "block";
    document.getElementById("overlay").style.display = "block";
    menu.innerHTML = `
      <button onclick="pinChat(${i})">üìå ‡§™‡§ø‡§®/‡§Ö‡§®‡§™‡§ø‡§® ‡§ï‡§∞‡§æ</button>
      <button onclick="renameChat(${i})">‚úèÔ∏è ‡§®‡§æ‡§µ ‡§¨‡§¶‡§≤‡§æ</button>
      <button onclick="deleteChat(${i})" style="color:red">üóëÔ∏è ‡§°‡§ø‡§≤‡•Ä‡§ü ‡§ï‡§∞‡§æ</button>
      <button onclick="hideOptions()">‚ùå ‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡§æ</button>
    `;
  }

  function hideOptions() { document.getElementById("optionBox").style.display = "none"; }
  function pinChat(i) { history[i].pin = !history[i].pin; save(); hideOptions(); }
  function deleteChat(i) { history.splice(i, 1); if(currentChatIndex === i) startNewChat(); save(); hideOptions(); }
  function renameChat(i) { 
    const n = prompt("‡§®‡§µ‡•Ä‡§® ‡§®‡§æ‡§µ:", history[i].txt); 
    if(n) { history[i].txt = n; save(); } 
    hideOptions(); 
  }
  
  function filterHistory() {
    const term = document.getElementById("searchHistory").value.toLowerCase();
    renderHistory(history.filter(h => h.txt.toLowerCase().includes(term)));
  }

  function clearAllHistory() {
    if (confirm("‡§∏‡§∞‡•ç‡§µ ‡§π‡§ø‡§∏‡•ç‡§ü‡•ç‡§∞‡•Ä ‡§™‡•Å‡§∏‡§æ‡§Ø‡§ö‡•Ä ‡§ï‡§æ?")) {
      localStorage.removeItem("chatHistory");
      history = []; renderHistory(); startNewChat();
    }
  }
</script>
</body>
</html>
